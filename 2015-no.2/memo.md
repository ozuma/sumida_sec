# 今回のテーマ：隠す(hide)

Hide in shadow → ambushってWizardy 5にありましたね

## ITセキュリティにおける「隠す」

- 攻撃、あるいはそれに準じる行為を隠す
    - nmapでゆっくりスキャンする(-T1)。1日1ポートスキャンすればたぶん絶対に気付かれない
    - ShellShockで、UserAgentなど目立つヘッダではなく、X-Hogehoge:みたいな誰もログを取らないだろうヘッダに入れている攻撃者もいた
- セキュリティルールをかいくぐるために隠す
    - VPNによるトンネル
    - 443/tcp(https)で、httpsでは無いものを通す
    - ICMP(ping)のペイロードにメッセージを入れてしまう
- リソースを隠す
    - pingへの応答をしないようにする(ホストの存在を隠す)、対Host Discovery
    - 開放ポートを隠す(SYNスキャンに対して、全開放しているかのように振る舞うIPSがある)
    - ソフトウェアの情報を隠す
        - バナーを出さない
        - デバッグモードのOFF
        - システム関連のエラーメッセージは内部ログのみに出し、Webブラウザには表示させない、など(Perlの`use CGI::Carp qw(fatalsToBrowser);`)
    - 秘密ファイルを推測できないパスに設置する

攻撃側による「行為を隠す」のと、防御側による「リソースを隠す(ホストの存在、開放ポート、ミドルウェアのバナーなど)」が多いかな。どちらかというと、SYNスキャンをステルススキャンと呼ぶように、攻撃側の「隠す」需要が多い。

## 探査行為を隠す

- 潜水艦のソナー
    - パッシブソナー：音を聞くだけなので、探査していることを相手に察知されない。方位しか分からない(距離が分からない)、相手が止まっている時は分からない
    - アクティブソナー：戦闘機などのレーダーと同じ。探査のための音波を発射して、その反射から敵艦の位置を測定する。浴びた方も確実に気付くし、自艦の方位も取られるので諸刃の剣。
    - 詳しくは「沈黙の艦隊」を読もう!
    - ステルス性：反射波が少ない。スキャンされても気付かれないようにする

- ポートスキャンを隠す
    - TCPコネクトスキャンではなく、SYNスキャンを使う
    - ゆっくりしていってね!!!!!
        - タイミングオプションで、-T1などを使う
        - 極端な話、1日1個しかポートスキャンしなければ、たぶん相手は気付かない。ITセキュリティにおいて攻撃側が有利と言われる理由の一つに、いくらでも遅くできるという点がある
    - 基本的にセキュリティ監視では、アラートのしきい値を設定しているので、そのしきい値以下となるようにみんながシノギを削っている
    - 逆に、潜水艦のアクティブソナーに当たるようなAggressiveなスキャンも散見されるけど、それは本講ではあまり考えない

## 実演：nmapでスキャンを隠す手法

### TCPスキャンの手法解説

SYNスキャン、コネクトスキャンの違い（基本的すぎるかな……）

nmapのオプションは、一般的なUNIXコマンドのオプションと違うのでとても分かりにくい。以下のポイントを先に頭に入れて理解しよう。

- 1文字オプションと2文字オプションの系列があり、これらは全く別物である。
    - たとえば、`-S`と`-sS`は全く関係ない。
- 1文字オプションは、一般的なUNIXコマンドと同様に単独で様々な動作を指定する。
- 2文字オプションは、1文字目が機能を、2文字目がその値を指定する。
    - たとえば、`-sS`、`-sU`、`-sT`があるが、これは1文字目の小文字sが「スキャンモード」を指定することを意味し、2文字目の`S`はSYNスキャン、`U`はUDPスキャン、`T`はTCPコネクトスキャンを意味している。
    - たとえば、`-oN`、`-oX`では`-o`がOUTPUTモードの指定、2文字目の`N`はNormal出力、`X`はXML出力を意味する

スキャンモードを省略すると、`-sS`を指定したものとみなされる。これはSYNスキャンで、高速かつ対象のログに残りにくいため、スキャン行為を隠しやすく、攻撃者にとってもっともポピュラーなスキャン。脆弱性検査などのポートスキャンでもよく使われる。ただし最近は、これに対抗するためにSYNスキャンを検知するとなんでもかんでも開放しているように応答を返すFWがある。ホーミングミサイルに対するチャフみたいなものですね。

### タイミングテンプレート (-Tオプション)

SYNスキャンするだけでは、バレバレなので探査行為を隠しているとはとても言えない。そこで慎重な攻撃者はIDSなどによる検知をかいくぐるため、タイミングテンプレートを利用する。

nmapではプローブ間隔やタイムアウトをどれだけ待つか、並列処理の調整など色々細かく設定できるんだけど、それらを個別に調整するのは難しい。そのため、それらをまるっと指定するためのテンプレートが用意されている。それがタイミングテンプレート、-Tオプション。スキャン時、どれくらい遅いのか示す。1文字オプション(引数を取る)なので簡単ですね。

#### 余談：最近のLinuxのオプション

ちなみに一般的なUNIXコマンドのオプションでも、引数の間のスペースは入れても入れなくてもいいことを知っていましたか。

```
$ tail -n1 app.log

$ tail -n 1 app.log
```

これ、どちらでも同じです。一部歴史的なコマンドはこれに対応していないことがありますが、最近のGNUコマンドならほぼ確実にだいじょうぶです。ただしnmapのTオプションは、慣例的にスペースを入れることはほとんど無く、`-T4`のように指定します。わき道にそれたので元に戻りましょう。


### タイミング指定によってどのくらい変わるのか

- 通常のオプションは何か？ → -T3

> https://nmap.org/man/jp/man-performance.html
> テンプレート名は、paranoid (0)、sneaky (1)、polite (2)、normal (3)、aggressive (4)、insane (5)である。

- paranoid: 偏執症スキャン
- sneaky: こそこそスキャン
- polite: 丁重なスキャン
- normal: 標準スキャン
- aggressive: けんか腰スキャン
- insane: キチガイスキャン

Politeモードは、通常(-T3)に比べて10倍の時間がかかる。Paranoidなら1ポートごとに5分待つので、IDSなどでアラートが上がることはまず無いだろう。

★実際にT0でスキャンしてみてWiresharkで確認する。

> T0の主な効果は、スキャンを連続的に実行して一度に1つのポートしかスキャンされないようにすることと、各プローブを送信する間に5分間待機することである。T1 と T2は似ているが、それぞれプローブ間の待機時間が15秒と0.4秒しかない。T3はNmapのデフォルト動作で、並列処理が含まれる。T4は--max-rtt-timeout 1250 --initial-rtt-timeout 500に相当し、TCPスキャンの最大遅延時間を10msに設定する。T5は--max-rtt-timeout 300 --min_rtt_timeout 50 --initial-rtt-timeout 250 --host-timeout 900000に相当し、TCPスキャンの最大遅延時間を5msに設定する。

ゆっくり探索すれば気づかれない。江戸時代の忍者、「草」にも似たようなイメージがあります。

## 防御側：リソースを隠す

色々あるけど、本講ではsshのポート番号を22/tcpから変えるのどうよ問題と、それに対する議論のネタとして「科学忍法・ssh分身の術」をお見せします(やっと本題に来た)。

# 科学忍法・ssh分身の術
    
若い人のために先に解説しておくと、この科学忍法というのはタツノコプロのガッチャマンという……まぁいいか。

## sshのポート番号問題

もはや宗教論争になるので、ここであまり深入りはしないことにしますが。VPSやクラウドなどで、sshのポートをデフォルトの22/tcpから変えるべきかどうか? という問題があります。

- 変える派
    - 攻撃者は真っ先に22/tcpを狙ってくるから変えたほうが攻撃されにくい、あるいは攻撃対象として選定されにくい
    - ログ監視などしている際、劇的にアタックログが減るからやった方が良い
    - 多くのドキュメントで変えることが推奨されているから変えたほうがいい(消極的派)
- 変えても意味ないよ派
    - ポートスキャンすれば一発でsshのポートは分かるんだからムダだよ
    - ポートを変えるだけでセキュリティ対策しているつもりになっちゃうからダメだよ(鍵認証onlyにしろよ派)

私は、「ポートを変えるだけでピンポンダッシュをほぼゼロにできるんだからやった方がいいでしょ」派です。ポートを変えるという簡単な設定で劇的な攻撃の減少ができるんだから、そりゃやった方がいい。

で、ここで変えても意味ないよ派にあえて対抗したい。「ポートスキャンすればどうせ一発で分かる」……よし、じゃぁ一発で分からないようにしてやろうじゃねぇか、というのがそもそもの発端です。ああ長かった。


